# -------------------------------------------------------
# if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
#   source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
# fi

# -------------------------------------------------------
# Colorscript
# -------------------------------------------------------
# if [[ -x "$HOME/github/shell-color-scripts/colorscript.sh" ]]; then
#   "$HOME/github/shell-color-scripts/colorscript.sh" -r
# fi

# -------------------------------------------------------
# OH-MY-ZSH
# -------------------------------------------------------
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="fishy"
# ZSH_THEME="refined"

plugins=(
  # git
  vi-mode
  zsh-autosuggestions
  zsh-syntax-highlighting
)

source $ZSH/oh-my-zsh.sh

# -------------------------------------------------------
# VI MODE â€” CURSOR SHAPE + COLOR
# -------------------------------------------------------

bindkey -v
export KEYTIMEOUT=1

# Cursor shape helper
set_cursor_shape() {
  printf '\e[%d q' "$1"
}

# Cursor color helper
set_cursor_color() {
  printf '\e]12;%s\a' "$1"
}

# Mode switch
zle-keymap-select() {
  case $KEYMAP in
    vicmd)
      MODE="NORMAL"
      set_cursor_shape 1
      set_cursor_color "#ebdbb1"
      ;;
    visual|vivis|viopp)
      MODE="VISUAL"
      set_cursor_shape 1
      set_cursor_color "#ebdbb1"
      ;;
    viins|main)
      MODE="INSERT"
      set_cursor_shape 5
      set_cursor_color "#ebdbb1"
      ;;
  esac
  zle reset-prompt
}
zle -N zle-keymap-select

# Insert mode on new prompt
zle-line-init() {
  MODE="INSERT"
  set_cursor_shape 5
  set_cursor_color "#ebdbb1"
  zle reset-prompt
}
zle -N zle-line-init

# TRAPINT() {
#   MODE="INSERT"
#   set_cursor_shape 5
#   set_cursor_color "#a6e3a1"
#   return 128
# }

ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=#aaa28f'

# -------------------------------------------------------
# ENVIRONMENT
# -------------------------------------------------------

export TERM="alacritty"
export EDITOR="nvim"
export VISUAL="nvim"
export BROWSER="waterfox"


# -------------------------------------------------------
# ALIASES
# -------------------------------------------------------

alias .1='cd ..'
alias .2='cd ../..'
alias .3='cd ../../..'
alias .4='cd ../../../..'
alias .5='cd ../../../../..'

alias jctl="journalctl -e"

# shell switching
alias tobash="doas chsh $USER -s /bin/bash && echo 'Now log out.'"
alias tozsh="doas chsh $USER -s /bin/zsh && echo 'Now log out.'"
alias tofish="doas chsh $USER -s /bin/fish && echo 'Now log out.'"

#my config 
alias X='doas chmod 777'
alias x='doas chmod 744'
alias ds='doas'
alias pmi='doas pacman -S'
alias pmu='doas pacman -Syyu'
alias pmuu='paru -Syu'
alias pmo='doas pacman -Sy'
alias pmr='doas pacman -Rs'
alias pmR='doas pacman -Rd --nodeps' #remove pkg without dependencies
alias pmii='paru -S'
alias pmq='pacman -Q'
alias pmqf="expac --timefmt='%Y-%m-%d %H:%M:%S' '%l %n %v' | sort -r | fzf"
alias pmqt="expac --timefmt='%Y-%m-%d %H:%M:%S' '%l %n %v' | sort -r"
alias pmn='pacman -Q | wc -l'
alias pmc='doas pacman -Sc' #clean the cache after upgrade my system 
alias md='mkdir'
alias config='/home/omar/scripts/configs.sh'
alias gc='cd ~/.config'
alias ram='ps axh -o cmd:15,%mem --sort=-%mem | head | string trim'
alias cpu='ps axh -o cmd:15,%cpu --sort=-%cpu | head'
alias bup='sh /home/omar/scripts/gitupload.sh'
alias df='dysk -c fs+type+size+used+free+use+mp'
alias dfdr='dust'
alias dfd='dust -r'
alias printer='system-config-printer'
alias printerinstall='hp-setup -u'
alias epdf='okular'
alias gt='cd ~/.local/share/Trash/files'
alias gs='cd ~/scripts'
alias m='~/scripts/matrix.sh'
alias gx='cd /usr/share/xsessions'
alias ft='xdg-mime query filetype'
alias fd='xdg-mime query default'
alias rip='~/scripts/rip.sh' #to get public ip 
alias ll='lsd -lh'
alias la="lsd -lah"
alias l="lsd"
alias ls="lsd"
alias llp="lsd -lh --permission octal"
alias lls="lsd -lhS"
alias llt="lsd -lht"
alias llS="lsd -l --total-size 2> /dev/null"
alias gcalc='gnome-calculator'
alias calc='kalker'
alias gm='cd /mnt'
alias code='vscodium'
alias gsh="~/scripts/gsh.sh"
# alias ns="nvidia-smi"
# alias nr="prime-run"
alias rf='source ~/.config/fish/config.fish'
alias rkeys="~/scripts/keys.sh"
alias rmpm="doas rm /var/lib/pacman/db.lck"
alias cat="lolcat"
alias prop="xprop | grep WM_CLASS"
alias dl="~/scripts/dlfile.sh"
alias dlmv="~/scripts/mvdragon.sh"
alias dlcp="~/scripts/cpdrag.sh"
alias phn="~/scripts/scrcpy.sh"
alias pipes="pipes.sh"
alias st="speedtest-cli --simple --secure"
alias stm="nload -u m -m wlp3s0"
alias win="~/scripts/windows.sh"
alias swm="~/scripts/switch.sh"
alias mega="megabasterd"
alias ping="ping -c 20"
alias dr='~/scripts/dr.sh'
alias mm='~/scripts/mount_manager.sh'
alias rr='~/scripts/rsync.sh'
alias topdf='~/scripts/build-latex.sh'
alias gif='~/scripts/gif.sh'
alias bat='bat --theme gruvbox-dark'
alias rm='trash-put -ir'
alias rmPrm='trash-empty -vi'
alias dbls='~/scripts/dbdb.sh'
alias db='~/scripts/dbrowse.sh'
alias khal='khal calendar'
alias k='kubectl'
alias h='helm'
alias tg='tgpt'
alias dp='dropbox start -i'
alias mx='ncpamixer -t i'
alias gv='cd .config/nvim'
alias gg='git-graph' # and install git-delta
alias sx="ls -1t --classic | xargs swallow sxiv 2> /dev/null"
alias sxiv="ls -1t --classic | xargs swallow sxiv 2> /dev/null"
alias tf="terraform"
alias glow='glow -l'
alias vu='vagrant up'
alias vh='vagrant halt'
alias vs='vagrant ssh'
alias yz='yazi'
alias v='nvim'
alias gd='cd ~/Documents/GitHub/'

# -------------------------------------------------------
# ZOXIDE
# -------------------------------------------------------
eval "$(zoxide init zsh)"
alias cd='z'      # zoxide pkg

# -------------------------------------------------------
# FUNCTIONS
# -------------------------------------------------------

se() {
    cd ~/scripts || return
    fzf --preview 'bat --style=numbers --color=always --line-range :500 {}' \
        | xargs -r /bin/bash
    cd - >/dev/null || return
}

keys() {
    xev | awk -F'[ )]+' '/^KeyPress/ { a[NR+2] } NR in a { printf "%-3s %s\n", $5, $8 }'
}

sv() {
    ~/scripts/dmenu_service.sh
}

pmsi() {
    pacman -Slq \
        | fzf --multi --preview 'pacman -Si {1}' \
        | xargs -ro doas pacman -S
}

pmsii() {
    paru -Slq \
        | fzf -m --preview 'paru -Si {1}' \
        | xargs -ro paru -S
}

pmsr() {
    pacman -Qq \
        | fzf --multi --preview 'pacman -Qi {1}' \
        | xargs -ro doas pacman -Rns
}

sc() {
    cd ~/scripts/ || return
    fzf --preview 'bat --style=numbers --color=always --line-range :500 {}' \
        | xargs -r -I % "$EDITOR" %
    cd - >/dev/null || return
}

f() {
    local term="$1"
    [ -z "$term" ] && echo "Usage: f <pattern>" && return 1
    doas find / -iname "*$term*" 2>/dev/null
}

# -------------------------------------------------------
# NNN CONFIGURATION
# -------------------------------------------------------
[ -f ~/.nnn_env.zsh ] && source ~/.nnn_env.zsh
alias n='nnn -rRxl 5'
alias ns="tr '\0' '\n' < \"${NNN_SEL:-/tmp/.sel}\""

# -------------------------------------------------------
# Custom Functions
# -------------------------------------------------------
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘      ZSH Keyboard Shortcuts            â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘ Ctrl+f    â”‚ Fuzzy find & open file     â•‘
# â•‘ Alt+d     â”‚ Fuzzy find & cd directory  â•‘
# â•‘ Alt+p     â”‚ Show current directory     â•‘
# â•‘ Alt+r     â”‚ Reload zsh config          â•‘
# â•‘ Alt+v     â”‚ Execute temp script        â•‘
# â•‘ Ctrl+r    â”‚ Search command history     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Alt+s Fuzzy find and open file in nvim
fzf-file-widget() {
  local file
  file=$(find . -type f | fzf --preview 'bat --style=numbers --color=always {} 2>/dev/null || cat {}' --preview-window=right:60%)
  if [[ -n $file ]]; then
    nvim "$file"
  fi
  zle reset-prompt
}

zle -N fzf-file-widget
bindkey '^[s' fzf-file-widget
# bindkey '^F' fzf-file-widget

# Alt+d - CD into any subdirectory
fzf-cd-widget() {
  local dir
  dir=$(find . -type d -not -path '*/.*' 2>/dev/null | fzf --preview 'ls -la {}')
  if [[ -n $dir ]]; then
    cd "$dir"
    zle reset-prompt
  fi
}
zle -N fzf-cd-widget
bindkey '^[d' fzf-cd-widget

# Extract any archive
ext() {
  if [ -f $1 ]; then
    case $1 in
      *.tar.bz2)   tar xjf $1     ;;
      *.tar.gz)    tar xzf $1     ;;
      *.bz2)       bunzip2 $1     ;;
      *.rar)       unrar e $1     ;;
      *.gz)        gunzip $1      ;;
      *.tar)       tar xf $1      ;;
      *.tbz2)      tar xjf $1     ;;
      *.tgz)       tar xzf $1     ;;
      *.zip)       unzip $1       ;;
      *.Z)         uncompress $1  ;;
      *.7z)        7z x $1        ;;
      *)           echo "'$1' cannot be extracted" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Alt+k - Kill process interactively
fzf-kill-widget() {
  local pid
  pid=$(ps -ef | sed 1d | fzf -m --preview 'echo {}' --preview-window=down:3:wrap | awk '{print $2}')
  if [[ -n $pid ]]; then
    echo $pid | xargs kill -${1:-9}
  fi
  zle reset-prompt
}
zle -N fzf-kill-widget
bindkey '^[k' fzf-kill-widget

# Ctrl+r FZF HISTORY
fzf-history-widget() {
  local selected
  selected=$(fc -l 1 | tac | fzf --height=70% --reverse --border \
      | sed 's/ *[0-9]* *//') || return

  LBUFFER=$selected
  CURSOR=${#LBUFFER}
  zle reset-prompt
}
zle -N fzf-history-widget
bindkey '^R' fzf-history-widget

# # Alt+p - Show current directory path (enhanced)
# pwd-widget() {
#   echo ""
#   echo -e "\033[1;36mCurrent Directory:\033[0m"
#   pwd
#   # echo -e "\033[1;33m$(ls -1 | wc -l) items\033[0m"
#   zle reset-prompt
# }
# zle -N pwd-widget
# bindkey '^[p' pwd-widget

# Alt+p - Show detailed current directory info
pwd-widget() {
  echo ""
  echo -e "\033[1;36mðŸ“ Current Directory:\033[0m" "$(pwd)"
  
  # Show number of files
  local file_count=$(ls -1 | wc -l)
  echo -e "\033[1;33mðŸ“Š Items: $file_count\033[0m"
  
  # Show directory size
  local dir_size=$(du -sh . 2>/dev/null | cut -f1)
  echo -e "\033[1;32mðŸ’¾ Size: $dir_size\033[0m"
  
  # Show git branch if in a git repo
  if git rev-parse --git-dir > /dev/null 2>&1; then
    local branch=$(git branch --show-current 2>/dev/null)
    echo -e "\033[1;35mðŸŒ¿ Git: $branch\033[0m"
  fi
  
  zle reset-prompt
}
zle -N pwd-widget
bindkey '^[p' pwd-widget

# Alt+e - Extract archive using FZF
# fzf-extract-widget() {
#   local file
#   file=$(find . -maxdepth 3 -type f \( -name "*.zip" -o -name "*.tar.gz" -o -name "*.rar" -o -name "*.7z" -o -name "*.tar.bz2" -o -name "*.tgz" \) 2>/dev/null | fzf --preview 'ls -lh {}')
#   if [[ -n $file ]]; then
#     echo "Extracting: $file"
#     extract "$file"
#   fi
#   zle reset-prompt
# }
# zle -N fzf-extract-widget
# bindkey '^[e' fzf-extract-widget

# Alt+r - Reload zsh configuration
reload-zsh-widget() {
    echo ""
    echo "ðŸ”„ Reloading zsh configuration..."
    source ~/.zshrc
    echo "âœ“ Configuration reloaded!"
    zle reset-prompt
}
zle -N reload-zsh-widget
bindkey '^[r' reload-zsh-widget

# Alt+v - Quick execute temp script
exec-temp() {
    local tmpfile=$(mktemp /tmp/zsh-exec-XXXXXX.sh)
    ${EDITOR:-nvim} "$tmpfile"
    [[ -s "$tmpfile" ]] && source "$tmpfile"
    rm -f "$tmpfile"
    zle reset-prompt
}
zle -N exec-temp
bindkey '^[v' exec-temp

