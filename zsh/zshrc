# -------------------------------------------------------
# Colorscript
# -------------------------------------------------------
if [[ -x "$HOME/github/shell-color-scripts/colorscript.sh" ]]; then
  "$HOME/github/shell-color-scripts/colorscript.sh" -r
fi

# pokemon-colorscripts --no-title -r --no-title

# -------------------------------------------------------
# PATH and VAR
# -------------------------------------------------------
export PATH="$HOME/.cargo/bin:$PATH"
export XDG_CONFIG_HOME="$HOME/.config"

# -------------------------------------------------------
# OH-MY-ZSH
# -------------------------------------------------------
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="fishy"
# ZSH_THEME="refined"

plugins=(
  vi-mode
  zsh-autosuggestions
  zsh-syntax-highlighting
)

source $ZSH/oh-my-zsh.sh

# -------------------------------------------------------
# History
# -------------------------------------------------------
HISTFILE=~/.zsh_history
HISTSIZE=100000
SAVEHIST=100000

setopt HIST_IGNORE_SPACE        # ignore commands starting with space
setopt HIST_IGNORE_ALL_DUPS     # remove older duplicate commands
setopt HIST_SAVE_NO_DUPS        # don't write duplicates to file
setopt SHARE_HISTORY            # share between sessions

# -------------------------------------------------------
# VI MODE â€” CURSOR SHAPE + COLOR
# -------------------------------------------------------
bindkey -v
export KEYTIMEOUT=1
function zle-keymap-select {
  if [[ ${KEYMAP} == vicmd ]] ||
     [[ $1 = 'block' ]]; then
    echo -ne '\e[1 q'
  elif [[ ${KEYMAP} == main ]] ||
       [[ ${KEYMAP} == viins ]] ||
       [[ ${KEYMAP} = '' ]] ||
       [[ $1 = 'beam' ]]; then
    echo -ne '\e[5 q'
  fi
}
zle -N zle-keymap-select
zle-line-init() {
    zle -K viins # initiate `vi insert` as keymap (can be removed if `bindkey -V` has been set elsewhere)
    echo -ne "\e[5 q"
}
zle -N zle-line-init
echo -ne '\e[5 q' # Use beam shape cursor on startup.
preexec() { echo -ne '\e[5 q' ;} # Use beam shape cursor for each new prompt.

# zle-keymap-select() {
#   case $KEYMAP in
#     vicmd)
#       MODE="NORMAL"
#       set_cursor_shape 1
#       set_cursor_color "#ebdbb1"
#       ;;
#     visual|vivis|viopp)
#       MODE="VISUAL"
#       set_cursor_shape 1
#       set_cursor_color "#ebdbb1"
#       ;;
#     viins|main)
#       MODE="INSERT"
#       set_cursor_shape 5
#       set_cursor_color "#ebdbb1"
#       ;;
#   esac
#   zle reset-prompt
# }
# zle -N zle-keymap-select
#
# # Insert mode on new prompt
# zle-line-init() {
#   MODE="INSERT"
#   set_cursor_shape 5
#   set_cursor_color "#ebdbb1"
#   zle reset-prompt
# }
# zle -N zle-line-init

# TRAPINT() {
#   MODE="INSERT"
#   set_cursor_shape 5
#   set_cursor_color "#a6e3a1"
#   return 128
# }

ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=#aaa28f'

# -------------------------------------------------------
# ENVIRONMENT
# -------------------------------------------------------

export TERM="alacritty"
export EDITOR="nvim"
export VISUAL="nvim"
export BROWSER="firefox"

# -------------------------------------------------------
# FZF-TAB
# -------------------------------------------------------
autoload -Uz compinit
compinit
source ~/.oh-my-zsh/custom/plugins/fzf-tab/fzf-tab.plugin.zsh
zstyle ':completion:*' menu no

# -------------------------------------------------------
# ALIASES
# -------------------------------------------------------

alias .1='cd ..'
alias .2='cd ../..'
alias .3='cd ../../..'
alias .4='cd ../../../..'
alias .5='cd ../../../../..'

alias jctl="journalctl -e"

# shell switching
alias tobash="doas chsh $USER -s /bin/bash && echo 'Now log out.'"
alias tozsh="doas chsh $USER -s /bin/zsh && echo 'Now log out.'"
alias tofish="doas chsh $USER -s /bin/fish && echo 'Now log out.'"

#my config 
alias X='doas chmod 777'
alias x='doas chmod 744'
alias ds='doas'
alias pmi='doas pacman -S'
alias pmu='doas pacman -Syyu'
# alias pmuu='paru -Syu'
alias pmuu='yay -Syu'
alias pmo='doas pacman -Sy'
alias pmr='doas pacman -Rs'
alias pmR='doas pacman -Rd --nodeps' #remove pkg without dependencies
# alias pmii='paru -S'
alias pmii='yay -S'
alias pmq='pacman -Q'
alias pmqf="expac --timefmt='%Y-%m-%d %H:%M:%S' '%l %n %v' | sort -r | fzf"
alias pmqt="expac --timefmt='%Y-%m-%d %H:%M:%S' '%l %n %v' | sort -r"
alias pmn='pacman -Q | wc -l'
alias pmc='doas pacman -Sc' #clean the cache after upgrade my system 
alias md='mkdir'
alias config='/home/omar/scripts/configs.sh'
alias gc='cd ~/.config'
alias ram='ps axh -o cmd:15,%mem --sort=-%mem | head'
alias cpu='ps axh -o cmd:15,%cpu --sort=-%cpu | head'
alias bup='sh /home/omar/scripts/gitupload.sh'
alias df='dysk -c fs+type+size+used+free+use+mp'
alias dfdr='dust'
alias dfd='dust -r'
alias printer='system-config-printer'
alias printerinstall='hp-setup -u'
alias epdf='okular'
alias gt='cd ~/.local/share/Trash/files'
alias gs='cd ~/scripts'
alias m='~/scripts/matrix.sh'
alias gx='cd /usr/share/xsessions'
alias ft='xdg-mime query filetype'
alias fd='xdg-mime query default'
alias rip='~/scripts/rip.sh' #to get public ip 
alias ll='lsd -lh'
alias la="lsd -lah"
alias l="lsd"
alias ls="lsd"
alias llp="lsd -lh --permission octal"
alias lls="lsd -lhS"
alias llt="lsd -lht"
alias llS="lsd -l --total-size 2> /dev/null"
alias gcalc='gnome-calculator'
alias calc='kalker'
alias gm='cd /mnt'
alias code='vscodium'
alias gsh="~/scripts/gsh.sh"
alias rf='source ~/.config/fish/config.fish'
alias rkeys="~/scripts/keys.sh"
alias cat="lolcat"
alias prop="xprop | grep WM_CLASS"
alias dl="~/scripts/dlfile.sh"
alias dlmv="~/scripts/mvdragon.sh"
alias dlcp="~/scripts/cpdrag.sh"
alias phn="~/scripts/scrcpy.sh"
alias pipes="pipes.sh"
alias st="speedtest-cli --simple --secure"
alias stm="nload -u m -m wlp3s0"
alias win="~/scripts/windows.sh"
alias swm="~/scripts/switch.sh"
# alias mega="megabasterd"
alias ping="ping -c 20"
alias dr='~/scripts/dr.sh'
alias mm='~/scripts/mount_manager.sh'
alias rr='~/scripts/rsync.sh'
alias topdf='~/scripts/build-latex.sh'
alias gif='~/scripts/gif.sh'
alias bat='bat --theme gruvbox-dark'
# alias rm='trash-put -ir'
alias te='trash-empty -vi'
# alias dbls='~/scripts/dbdb.sh'
# alias db='~/scripts/dbrowse.sh'
alias khal='khal calendar'
alias k='kubectl'
alias h='helm'
alias tg='tgpt'
# alias dp='dropbox start -i'
alias mx='ncpamixer -t i'
alias gv='cd .config/nvim'
# alias gg='git-graph' # and install git-delta
alias sx="ls -1t --classic | xargs swallow sxiv 2> /dev/null"
alias sxiv="ls -1t --classic | xargs swallow sxiv 2> /dev/null"
alias tf="terraform"
alias glow='glow -l'
alias yz='yazi'
alias v='nvim'
alias gd='cd ~/Documents/GitHub/'
alias np='ncmpcpp'

# -------------------------------------------------------
# ZOXIDE
# -------------------------------------------------------
eval "$(zoxide init zsh)"
alias cd='z'      # zoxide pkg

# -------------------------------------------------------
# FUNCTIONS
# -------------------------------------------------------

rm() {
  trash-put -ir "$@"
}

se() {
    cd ~/scripts || return
    fzf --preview 'bat --style=numbers --color=always --line-range :500 {}' \
        | xargs -r /bin/bash
    cd - >/dev/null || return
}

keys() {
    xev | awk -F'[ )]+' '/^KeyPress/ { a[NR+2] } NR in a { printf "%-3s %s\n", $5, $8 }'
}

sv() {
    ~/scripts/dmenu_service.sh
}

pmsi() {
    pacman -Slq \
        | fzf --multi --preview 'pacman -Si {1}' \
        | xargs -ro doas pacman -S
}

pmsii() {
    # paru -Slq \
    #     | fzf -m --preview 'paru -Si {1}' \
    #     | xargs -ro paru -S
    yay -Slq \
        | fzf -m --preview 'yay -Si {1}' \
        | xargs -ro yay -S
}

pmsr() {
    pacman -Qq \
        | fzf --multi --preview 'pacman -Qi {1}' \
        | xargs -ro doas pacman -Rns
}

sc() {
    cd ~/scripts/ || return
    fzf --preview 'bat --style=numbers --color=always --line-range :500 {}' \
        | xargs -r -I % "$EDITOR" %
    cd - >/dev/null || return
}

f() {
    local term="$1"
    [ -z "$term" ] && echo "Usage: f <pattern>" && return 1
    doas find / -iname "*$term*" 2>/dev/null
}

# -------------------------------------------------------
# NNN CONFIGURATION
# -------------------------------------------------------
[ -f ~/.nnn_env.zsh ] && source ~/.nnn_env.zsh
alias n='nnn -rRxl 5'
alias ns="tr '\0' '\n' < \"${NNN_SEL:-/tmp/.sel}\""

# -------------------------------------------------------
# Custom Functions
# -------------------------------------------------------
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘      ZSH Keyboard Shortcuts            â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘ Alt+s     â”‚ Fuzzy find & open file     â•‘
# â•‘ Alt+d     â”‚ Fuzzy find & cd directory  â•‘
# â•‘ Alt+p     â”‚ Show current directory     â•‘
# â•‘ Alt+r     â”‚ Reload zsh config          â•‘
# â•‘ Alt+v     â”‚ Execute temp script        â•‘
# â•‘ Alt+i     â”‚ Execute fzf packages pickerâ•‘
# â•‘ Ctrl+r    â”‚ Search command history     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Alt+s Fuzzy find and open file in nvim
fzf-file-widget() {
  local file
  file=$(find . -type f | fzf --preview 'bat --style=numbers --color=always {} 2>/dev/null || cat {}' --preview-window=right:60%)
  if [[ -n $file ]]; then
    nvim "$file"
  fi
  zle reset-prompt
}

zle -N fzf-file-widget
bindkey '^[s' fzf-file-widget
# bindkey '^F' fzf-file-widget

# Alt+d - CD into any subdirectory
fzf-cd-widget() {
  local dir
  dir=$(find . -type d -not -path '*/.*' 2>/dev/null | fzf --preview 'ls -la {}')
  if [[ -n $dir ]]; then
    cd "$dir"
    zle reset-prompt
  fi
}
zle -N fzf-cd-widget
bindkey '^[d' fzf-cd-widget

# Extract any archive
ext() {
  if [ -f $1 ]; then
    case $1 in
      *.tar.bz2)   tar xjf $1     ;;
      *.tar.gz)    tar xzf $1     ;;
      *.bz2)       bunzip2 $1     ;;
      *.rar)       unrar e $1     ;;
      *.gz)        gunzip $1      ;;
      *.tar)       tar xf $1      ;;
      *.tbz2)      tar xjf $1     ;;
      *.tgz)       tar xzf $1     ;;
      *.zip)       unzip $1       ;;
      *.Z)         uncompress $1  ;;
      *.7z)        7z x $1        ;;
      *)           echo "'$1' cannot be extracted" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Alt+k - Kill process interactively
fzf-kill-widget() {
  local pid
  pid=$(ps -ef | sed 1d | fzf -m --preview 'echo {}' --preview-window=down:3:wrap | awk '{print $2}')
  if [[ -n $pid ]]; then
    echo $pid | xargs kill -${1:-9}
  fi
  zle reset-prompt
}
zle -N fzf-kill-widget
bindkey '^[k' fzf-kill-widget

# Ctrl+r FZF HISTORY
fzf-history() {
  local selected
  selected=$(
    sed 's/^: [0-9]\+:[0-9]\+;//' "$HISTFILE" \
    | awk '!seen[$0]++' \
    | tac \
    | fzf --height 70% --reverse --prompt='History> '
  )

  # If fzf was cancelled or nothing selected
  if [[ -z $selected ]]; then
    zle redisplay
    return
  fi

  LBUFFER+="$selected"
  zle redisplay
}

zle -N fzf-history
bindkey '^R' fzf-history

# Alt+p - Show detailed current directory info
pwd-widget() {
  # Do nothing if we are in HOME
  if [[ "$PWD" == "$HOME" ]]; then
    zle redisplay
    return
  fi

  echo ""
  echo -e "\033[1;36mðŸ“ Current Directory:\033[0m" "$PWD"

  # Show number of files
  local file_count
  file_count=$(ls -1 | wc -l)
  echo -e "\033[1;33mðŸ“Š Items: $file_count\033[0m"

  # Show directory size
  local dir_size
  dir_size=$(du -sh . 2>/dev/null | cut -f1)
  echo -e "\033[1;32mðŸ’¾ Size: $dir_size\033[0m"

  # Show git branch if in a git repo
  if git rev-parse --git-dir > /dev/null 2>&1; then
    local branch
    branch=$(git branch --show-current 2>/dev/null)
    echo -e "\033[1;35mðŸŒ¿ Git: $branch\033[0m"
  fi

  zle reset-prompt
}

zle -N pwd-widget
bindkey '^[p' pwd-widget

# Alt+r - Reload zsh configuration
reload-zsh-widget() {
    echo ""
    echo "ðŸ”„ Reloading zsh configuration..."
    source ~/.zshrc
    echo "âœ“ Configuration reloaded!"
    zle reset-prompt
}
zle -N reload-zsh-widget
bindkey '^[r' reload-zsh-widget

# Alt+v - Quick execute temp script
autoload edit-command-line; zle -N edit-command-line
bindkey '^[v' edit-command-line

# Alt+i - FZF PACKAGE PICKER
fzf_arch_packages() {
  yay -Slq | fzf \
    --multi \
    --prompt="ðŸ“¦ Package > " \
    --height=70% \
}
fzf-insert-arch-pkg() {
  local pkgs
  pkgs="$(fzf_arch_packages)"
  [[ -n "$pkgs" ]] && LBUFFER+="${pkgs//$'\n'/ } "
  zle redisplay
}
zle -N fzf-insert-arch-pkg
bindkey '^[i' fzf-insert-arch-pkg

